<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC断面計算（4断面一括）Ver.2.4</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap');
        
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #f8fafc; 
            color: #334155;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-mono { font-family: 'Roboto Mono', monospace; }

        /* カードのスタイル */
        .section-card { 
            min-width: 320px; 
            max-width: 360px;
            transition: all 0.2s ease;
        }
        .section-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* 数式表示用スタイル */
        .math-expr { font-family: 'Times New Roman', serif; font-style: italic; }
        .math-normal { font-style: normal; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 2px; font-size: 0.9em; }
        .numerator { border-bottom: 1px solid currentColor; padding: 0 2px; width: 100%; text-align: center; }
        .denominator { padding: 0 2px; width: 100%; text-align: center; }
        .sqrt { border-top: 1px solid currentColor; padding-top: 1px; margin-left: 1px; }
        .sqrt:before { content: "\221A"; margin-right: 1px; margin-left: -8px; vertical-align: top; font-size: 1.1em; }

        /* 入力フォーム */
        input[type="number"], select, input[type="text"] {
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        input[type="number"]:focus, select:focus, input[type="text"]:focus {
            outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* 印刷設定 (A4縦) */
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background-color: white; padding: 0; font-size: 9pt; }
            .no-print { display: none !important; }
            
            /* グリッドレイアウトで2列2行に配置 */
            .print-layout { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: auto auto;
                gap: 15px; 
                width: 100%;
            }
            
            .section-card { 
                width: 100% !important; min-width: 0 !important; max-width: none !important;
                border: 1px solid #ccc; box-shadow: none; break-inside: avoid;
                margin: 0;
            }
            
            /* 背景色の強制印刷 */
            .bg-slate-50 { background-color: #f8fafc !important; -webkit-print-color-adjust: exact; }
            .bg-blue-50 { background-color: #eff6ff !important; -webkit-print-color-adjust: exact; }
            .bg-emerald-50 { background-color: #ecfdf5 !important; -webkit-print-color-adjust: exact; }
            
            input, select { 
                border: none !important; background: transparent !important; 
                padding: 0 !important; text-align: right; font-weight: bold;
                -webkit-appearance: none; appearance: none;
            }
            /* 印刷時はselectの矢印を消す */
            select::-ms-expand { display: none; }
        }
    </style>
</head>
<body class="text-slate-800 bg-slate-100">

    <!-- ヘッダー -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-slate-200 px-4 py-2 flex flex-wrap items-center justify-between gap-4 no-print shadow-sm">
        <div class="flex items-center gap-2">
            <div class="p-1.5 bg-blue-600 rounded text-white"><i data-lucide="calculator" class="w-5 h-5"></i></div>
            <h1 class="text-base font-bold text-slate-800">RC断面計算 <span class="text-xs font-normal text-slate-500 ml-1">Ver.2.4 (道路土工準拠)</span></h1>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="showLogicInfo()" class="btn-tool"><i data-lucide="help-circle" class="w-4 h-4"></i> 解説</button>
            <div class="h-4 w-px bg-slate-300 mx-1"></div>
            <button onclick="saveData()" class="btn-tool"><i data-lucide="save" class="w-4 h-4"></i> 保存</button>
            <label class="btn-tool cursor-pointer"><i data-lucide="upload" class="w-4 h-4"></i> 読込<input type="file" id="fileInput" accept=".json" class="hidden" onchange="loadData(this)"></label>
            <button onclick="window.print()" class="btn-primary"><i data-lucide="printer" class="w-4 h-4"></i> 印刷</button>
        </div>
    </header>
    <style>
        .btn-tool { @apply flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded transition; }
        .btn-primary { @apply flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 rounded transition shadow-sm; }
    </style>

    <!-- メインコンテンツ -->
    <main class="p-4 overflow-x-auto min-h-screen">
        <div class="print-layout flex gap-4 pb-12 mx-auto" id="sections_container" style="width: max-content;">
            <!-- JSでカードを描画 -->
        </div>
    </main>

    <!-- ヘルプモーダル -->
    <div id="logic_modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-opacity opacity-0" style="transition: opacity 0.2s;">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="px-5 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center rounded-t-xl sticky top-0 z-10">
                <h3 class="text-base font-bold text-slate-800 flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-blue-600"></i> 計算ロジック・公式</h3>
                <button onclick="toggleModal(false)" class="p-1 hover:bg-slate-200 rounded-full text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 text-sm text-slate-600 leading-relaxed space-y-6">
                <!-- 1. 基礎理論 -->
                <section>
                    <h4 class="font-bold text-slate-800 border-l-4 border-blue-500 pl-3 mb-3 text-base">1. 基礎理論 (平面保持の仮定)</h4>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <div class="flex-1">
                            <p class="mb-2">鉄筋コンクリートの曲げ解析において、以下の仮定に基づき計算を行います。</p>
                            <ul class="list-disc pl-5 space-y-1 text-xs">
                                <li><strong>平面保持:</strong> 変形前の平面断面は、変形後も平面を保つ（ひずみ分布は直線）。</li>
                                <li><strong>線形弾性:</strong> コンクリートおよび鉄筋の応力はひずみに比例する（フックの法則）。</li>
                                <li><strong>引張無視:</strong> 引張側のコンクリート応力は無視する。</li>
                            </ul>
                        </div>
                        <div class="bg-slate-50 border border-slate-200 rounded p-3 text-center">
                            <div class="text-[10px] text-slate-400 font-bold mb-1">ひずみ・応力分布図</div>
                            <svg width="220" height="100" viewBox="0 0 220 100">
                                <rect x="10" y="10" width="40" height="80" fill="#e2e8f0" stroke="#64748b" />
                                <circle cx="30" cy="70" r="3" fill="#ef4444" />
                                <circle cx="30" cy="25" r="3" fill="#22c55e" />
                                <line x1="80" y1="10" x2="80" y2="90" stroke="#cbd5e1" stroke-dasharray="2 2" />
                                <line x1="70" y1="10" x2="90" y2="90" stroke="#ef4444" />
                                <text x="80" y="98" font-size="8" text-anchor="middle" fill="#64748b">ひずみ</text>
                                <line x1="160" y1="10" x2="160" y2="90" stroke="#cbd5e1" stroke-dasharray="2 2" />
                                <path d="M160,45 L145,10 L160,10 Z" fill="rgba(59,130,246,0.3)" stroke="#3b82f6" />
                                <line x1="160" y1="70" x2="180" y2="70" stroke="#ef4444" marker-end="url(#arr)" />
                                <text x="160" y="98" font-size="8" text-anchor="middle" fill="#64748b">応力</text>
                                <defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#ef4444" /></marker></defs>
                            </svg>
                        </div>
                    </div>
                </section>

                <!-- 2. 曲げ応力度 -->
                <section>
                    <h4 class="font-bold text-slate-800 border-l-4 border-blue-500 pl-3 mb-3 text-base">2. 曲げ応力度 (Elastic Theory)</h4>
                    
                    <!-- A. 軸力あり -->
                    <div class="mb-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded block w-max mb-3">A. 軸力あり (<span class="math-expr">N ≠ 0</span>)</span>
                        
                        <p class="text-xs font-bold text-slate-700 mb-1">【中立軸 <span class="math-expr">x</span> の算定】</p>
                        <p class="text-xs mb-2 leading-relaxed">
                            外力 <span class="math-expr">N</span> の作用点周りのモーメントのつり合い条件から導かれる3次方程式を解きます。<br>
                            圧縮縁から <span class="math-expr">N</span> の作用点までの距離 <span class="math-expr">L</span> は、偏心距離 <span class="math-expr">e = M/N</span> を用いて <span class="math-expr">L = D/2 - e</span> となります。
                        </p>
                        <div class="text-center my-3 text-sm overflow-x-auto whitespace-nowrap">
                            <span class="math-expr">x<sup>3</sup> - 3Lx<sup>2</sup> - </span>
                            <div class="fraction"><span class="numerator"><span class="math-expr">6n</span></span><span class="denominator"><span class="math-expr">b</span></span></div>
                            <span class="math-expr">[A<sub>s</sub>'(L-d<sub>p</sub>) + A<sub>s</sub>(L-d)] x + </span>
                            <div class="fraction"><span class="numerator"><span class="math-expr">6n</span></span><span class="denominator"><span class="math-expr">b</span></span></div>
                            <span class="math-expr">[A<sub>s</sub>'d<sub>p</sub>(L-d<sub>p</sub>) + A<sub>s</sub>d(L-d)] = 0</span>
                        </div>

                        <p class="text-xs font-bold text-slate-700 mb-1 mt-4">【応力度の算定】</p>
                        <p class="text-xs mb-2">軸方向力のつり合い条件 <span class="math-expr">N = C + C' - T</span> より求めます。</p>
                        <div class="text-center my-2 text-base">
                            <span class="math-expr">σ<sub class="math-normal">c</sub></span> = 
                            <div class="fraction">
                                <span class="numerator"><span class="math-expr">N</span></span>
                                <span class="denominator">
                                    <div class="fraction"><span class="numerator"><span class="math-expr">bx</span></span><span class="denominator">2</span></div> + 
                                    <div class="fraction"><span class="numerator"><span class="math-expr">nA<sub>s</sub>'</span>(<span class="math-expr">x-d<sub class="math-normal">p</sub></span>)</span><span class="denominator"><span class="math-expr">x</span></span></div> - 
                                    <div class="fraction"><span class="numerator"><span class="math-expr">nA<sub>s</sub></span>(<span class="math-expr">d-x</span>)</span><span class="denominator"><span class="math-expr">x</span></span></div>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- B. 純曲げ -->
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded block w-max mb-3">B. 純曲げ (<span class="math-expr">N ≈ 0</span>)</span>
                        
                        <p class="text-xs font-bold text-slate-700 mb-1">【中立軸 <span class="math-expr">x</span> の算定】</p>
                        <p class="text-xs mb-2">
                            中立軸周りの断面一次モーメントのつり合い（<span class="math-expr">S<sub>c</sub> = S<sub>t</sub></span>）から導かれる2次方程式を解きます。<br>
                            <span class="math-expr">b/2 x<sup>2</sup> + nA<sub>s</sub>'(x-d<sub>p</sub>) - nA<sub>s</sub>(d-x) = 0</span>
                        </p>
                        <p class="text-xs mb-2">一般に中立軸比 <span class="math-expr">k = x/d</span> を用いて以下の通り求められます。</p>
                        <div class="text-center my-3 text-sm">
                            <span class="math-expr">k</span> = <span class="sqrt">2<span class="math-expr">n</span>(<span class="math-expr">p</span> + <span class="math-expr">p'</span><span class="fraction"><span class="numerator"><span class="math-expr">d<sub class="math-normal">p</sub></span></span><span class="denominator"><span class="math-expr">d</span></span></span>) + (<span class="math-expr">n</span>(<span class="math-expr">p</span>+<span class="math-expr">p'</span>))<sup>2</sup></span> - <span class="math-expr">n</span>(<span class="math-expr">p</span>+<span class="math-expr">p'</span>)
                        </div>

                        <p class="text-xs font-bold text-slate-700 mb-1 mt-4">【応力度の算定】</p>
                        <div class="text-center text-base">
                            <span class="math-expr">σ<sub class="math-normal">s</sub></span> = 
                            <div class="fraction">
                                <span class="numerator"><span class="math-expr">M</span></span>
                                <span class="denominator"><span class="math-expr">A<sub>s</sub></span> ⋅ <span class="math-expr">j</span> ⋅ <span class="math-expr">d</span></span>
                            </div>
                            <span class="text-sm ml-4 text-slate-500">(<span class="math-expr">j = 1 - k/3</span> 等の係数を使用)</span>
                        </div>
                    </div>
                </section>

                <!-- 3. せん断 -->
                <section>
                    <h4 class="font-bold text-slate-800 border-l-4 border-blue-500 pl-3 mb-3 text-base">3. せん断応力度 (道路土工指針)</h4>
                    <div class="bg-emerald-50 p-4 rounded border border-emerald-100 flex flex-col gap-3">
                        <div class="flex items-center gap-4">
                            <div class="text-sm font-bold w-24">発生応力度:</div>
                            <div class="text-base math-expr">
                                τ = <div class="fraction"><span class="numerator">S</span><span class="denominator">b ⋅ d</span></div>
                            </div>
                            <div class="text-xs text-slate-500">※平均せん断応力度</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-sm font-bold w-24">許容応力度:</div>
                            <div class="text-base math-expr">
                                f<sub class="math-normal">a</sub> = τ<sub class="math-normal">a1</sub> ⋅ C<sub class="math-normal">e</sub> ⋅ C<sub class="math-normal">pt</sub> ⋅ α
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs text-slate-600 ml-28">
                            <div><span class="font-bold">τ<sub>a1</sub></span> : コンクリート強度による基本値</div>
                            <div><span class="font-bold">C<sub>e</sub></span> : 寸法効果 <span class="math-expr">(1000/d)<sup>1/4</sup></span></div>
                            <div><span class="font-bold">C<sub>pt</sub></span> : 鉄筋比効果 <span class="math-expr">(100p<sub class="math-normal">t</sub>)<sup>1/3</sup></span></div>
                            <div><span class="font-bold">α</span> : 割増係数</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Javascript -->
    <script>
        lucide.createIcons();

        // --- 定数データ ---
        const REBAR_AREAS = {
            "D10": 71.33, "D13": 126.7, "D16": 198.6, "D19": 286.5,
            "D22": 387.1, "D25": 506.7, "D29": 642.4, "D32": 794.2,
            "D35": 956.6, "D38": 1140, "D41": 1340,
            "φ9": 63.6, "φ13": 132.7, "φ16": 201.1, "φ19": 283.5, "φ22": 380.1, "φ25": 490.9
        };

        const CONCRETE_DATA = {
            18: { sigCa: 6.0, tauA1: 0.21 }, 21: { sigCa: 7.0, tauA1: 0.22 }, 24: { sigCa: 8.0, tauA1: 0.23 },
            27: { sigCa: 9.0, tauA1: 0.24 }, 30: { sigCa: 10.0, tauA1: 0.25 }, 40: { sigCa: 13.0, tauA1: 0.29 },
            50: { sigCa: 16.0, tauA1: 0.31 }
        };

        const REBAR_DATA = {
            "SD295": { sigSa: 180, name: "SD295A/B" },
            "SD345": { sigSa: 180, name: "SD345(土工)" },
            "SD345_200": { sigSa: 200, name: "SD345(200)" },
            "SR235": { sigSa: 140, name: "SR235" }
        };

        const DEFAULT_SECTION = {
            name: "断面検討",
            b: 1000, D: 300, dt: 60, dp: 60,
            barSizeT: "D13", barCountT: 8, manualAs: null,
            barSizeC: "D13", barCountC: 4, manualAsp: null,
            N_kN: 0, M_kNm: 20, S_kN: 15,
            n: 15, Fc: 24, rebarType: "SD345", allowFactor: 1.00
        };

        let sections = [
            { ...DEFAULT_SECTION, name: "断面-1" }, { ...DEFAULT_SECTION, name: "断面-2" },
            { ...DEFAULT_SECTION, name: "断面-3" }, { ...DEFAULT_SECTION, name: "断面-4" }
        ];

        // --- 計算ロジック ---
        function calculateRC(s) {
            const conc = CONCRETE_DATA[s.Fc] || CONCRETE_DATA[24];
            const rebar = REBAR_DATA[s.rebarType] || REBAR_DATA["SD345"];
            const f = s.allowFactor || 1.0;

            const allow_sigC = conc.sigCa * f;
            const allow_sigS = rebar.sigSa * f;
            const allow_tauA1_base = conc.tauA1 * f; 

            const CALC_B = 1000.0;
            const width_ratio = CALC_B / s.b;
            const member_len_m = s.b / 1000.0; 

            const d = s.D - s.dt;
            const dp = s.dp;
            const n = s.n;

            const As_total = s.manualAs !== null ? s.manualAs : (REBAR_AREAS[s.barSizeT] || 0) * s.barCountT;
            const Asp_total = s.manualAsp !== null ? s.manualAsp : (REBAR_AREAS[s.barSizeC] || 0) * s.barCountC;
            const As = As_total * width_ratio;
            const Asp = Asp_total * width_ratio;
            
            const N_val = (s.N_kN / member_len_m) * 1000.0;     
            const M_val = (s.M_kNm / member_len_m) * 1000000.0; 
            const S_val = (s.S_kN / member_len_m) * 1000.0;     

            const b = CALC_B;

            let res = { 
                x: 0, sigma_c: 0, sigma_s: 0, sigma_sp: 0, 
                tau: 0, fa: 0, Ce: 1, Cpt: 1, 
                allow_sigC, allow_sigS, allow_tauA1_base,
                shearState: 'ok', bendStateC: 'ok', bendStateS: 'ok',
                state: 'ok', msg: '', As_total, Asp_total, d 
            };

            try {
                const EPS_N = 1e-6 * Math.max(Math.abs(N_val), 1.0);
                let x = null;

                if (Math.abs(N_val) < EPS_N) { // 純曲げ
                    const p = As / (b * d);
                    const pp = Asp / (b * d);
                    const t1 = 2 * n * (p + pp * dp / d);
                    const t2 = Math.pow(n * (p + pp), 2);
                    const k = Math.sqrt(t1 + t2) - n * (p + pp);
                    x = k * d;
                    res.x = x;
                    const num_j = Math.pow(k, 2) * (1 - k/3.0) + 2 * n * pp * (k - dp/d) * (1 - dp/d);
                    const den_j = Math.pow(k, 2) + 2 * n * pp * (k - dp/d);
                    const j_val = num_j / den_j;
                    const Lc = (k / 2.0) * (1 - k/3.0) + (n * pp / k) * (k - dp/d) * (1 - dp/d);
                    res.sigma_c = M_val / (b * Math.pow(d, 2) * Lc);
                    res.sigma_sp = (Math.abs(x) < 1e-9) ? 0 : n * res.sigma_c * (x - dp) / x;
                    res.sigma_s = M_val / (As * j_val * d);
                } else { // 軸力あり
                    const L = s.D / 2.0 - M_val / N_val;
                    const Coef1 = (6.0 * n / b) * (Asp * (L - dp) + As * (L - d));
                    const Coef2 = (6.0 * n / b) * (Asp * dp * (L - dp) + As * d * (L - d));
                    const F = (v) => Math.pow(v, 3) - 3 * L * Math.pow(v, 2) - Coef1 * v + Coef2;
                    const dF = (v) => 3 * Math.pow(v, 2) - 6 * L * v - Coef1;
                    x = 0.4 * d;
                    for(let i=0; i<100; i++) {
                        const fx = F(x);
                        const dfx = dF(x);
                        if(Math.abs(dfx) < 1e-12) break;
                        const nx = x - fx/dfx;
                        if(Math.abs(nx - x) < 1e-6) { x = nx; break; }
                        x = nx;
                    }
                    res.x = x;
                    const denom = 0.5 * b * x + n * Asp * (x - dp) / x - n * As * (d - x) / x;
                    if (Math.abs(denom) < 1e-9) throw new Error("denom≒0");
                    res.sigma_c = N_val / denom;
                    res.sigma_sp = (Math.abs(x) < 1e-5) ? 0 : n * res.sigma_c * (x - dp) / x;
                    res.sigma_s = (Math.abs(x) < 1e-5) ? 0 : n * res.sigma_c * (d - x) / x;
                }
                
                if(res.x <= 0 || res.x >= d) { res.state = 'warn'; res.msg = '全断面圧縮等'; }

                res.bendStateC = (Math.abs(res.sigma_c) <= allow_sigC) ? 'ok' : 'ng';
                res.bendStateS = (Math.abs(res.sigma_s) <= allow_sigS) ? 'ok' : 'ng'; 

                res.tau = S_val / (b * d);  
                let ce_val = Math.pow(1000.0 / d, 0.25);
                if (ce_val < 0.7) ce_val = 0.7; else if (ce_val > 1.5) ce_val = 1.5;
                res.Ce = ce_val;
                const pt = As / (b * d);
                let cpt_val = Math.pow(100.0 * pt, 1.0/3.0);
                if (cpt_val < 0.7) cpt_val = 0.7; else if (cpt_val > 1.5) cpt_val = 1.5;
                res.Cpt = cpt_val;
                res.fa = allow_tauA1_base * res.Ce * res.Cpt;
                res.shearState = (Math.abs(res.tau) <= res.fa) ? 'ok' : 'ng';

            } catch(e) {
                res.state = 'error'; res.msg = e.message;
            }
            return res;
        }

        // --- 描画関数 ---
        function drawSectionDetail(elemId, s, res) {
            const el = document.getElementById(elemId);
            if(!el) return;
            const W = 300, H = 120, padding = 30;
            
            const scaleX = (W - padding*2) / s.b;
            const scaleY = (H - 20) / s.D;
            const scale = Math.min(scaleX, scaleY);
            
            const drawW = s.b * scale;
            const drawH = s.D * scale;
            const originX = (W - drawW) / 2 - 10;
            const originY = (H - drawH) / 2;
            
            const getDia = (name) => {
                if(name.includes('D')) return parseInt(name.replace('D', '')) || 13;
                if(name.includes('φ')) return parseInt(name.replace('φ', '')) || 9;
                return 13;
            };
            const rT = Math.max(getDia(s.barSizeT) * scale / 2, 2); 
            const rC = Math.max(getDia(s.barSizeC) * scale / 2, 2);
            
            const y_t = originY + drawH - s.dt * scale;
            const y_c = originY + s.dp * scale;

            const makeCircles = (count, r, y, color) => {
                let svg = '';
                const cnt = Math.max(count, 1);
                const spanW = drawW * 0.8;
                const startX = originX + (drawW - spanW) / 2;
                if (cnt === 1) {
                    svg += `<circle cx="${originX + drawW/2}" cy="${y}" r="${r}" fill="${color}" stroke="white" stroke-width="0.5"/>`;
                } else {
                    const step = spanW / (cnt - 1);
                    for(let i=0; i<cnt; i++) svg += `<circle cx="${startX + step*i}" cy="${y}" r="${r}" fill="${color}" stroke="white" stroke-width="0.5"/>`;
                }
                return svg;
            };

            let svg = `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">`;
            svg += `<rect x="${originX}" y="${originY}" width="${drawW}" height="${drawH}" fill="#f1f5f9" stroke="#64748b" stroke-width="1.5"/>`;
            svg += makeCircles(s.barCountT, rT, y_t, "#ef4444");
            svg += makeCircles(s.barCountC, rC, y_c, "#22c55e");
            svg += `<text x="${originX + drawW + 5}" y="${originY + drawH/2}" font-size="10" fill="#64748b" dominant-baseline="middle">D=${s.D}</text>`;
            svg += `<text x="${originX + drawW/2}" y="${originY + drawH + 12}" font-size="10" fill="#64748b" text-anchor="middle">b=${s.b}</text>`;
            svg += `</svg>`;
            el.innerHTML = svg;
        }

        function drawStressDiagram(elemId, s, res) {
            const el = document.getElementById(elemId);
            if(!el) return;
            if(res.state === 'error') { el.innerHTML = ''; return; }
            const W = 280, H = 80;
            const scale = (H - 10) / s.D; 
            const centerX = W / 2, topY = 5;
            const y_na = topY + res.x * scale;
            const y_d = topY + res.d * scale;
            const y_dp = topY + s.dp * scale;
            const bottomY = topY + s.D * scale;
            const maxStress = Math.max(Math.abs(res.sigma_c), Math.abs(res.sigma_s)/15, 10);
            const sScale = 70 / maxStress; 
            const w_sc = Math.abs(res.sigma_c) * sScale;
            const w_ss = Math.abs(res.sigma_s/15) * sScale; 
            const strainTopX = centerX - w_sc;
            const getStrainX = (y) => (y - y_na) * (strainTopX - centerX) / (topY - y_na) + centerX;
            const strainBottomX = getStrainX(y_d + 10);
            const fmt = (v) => Math.abs(v).toFixed(1);

            let svg = `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}">`;
            svg += `<defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#475569" /></marker></defs>`;
            svg += `<line x1="${centerX}" y1="${topY}" x2="${centerX}" y2="${bottomY}" stroke="#cbd5e1" stroke-dasharray="2 2" />`;
            svg += `<line x1="${centerX-20}" y1="${y_na}" x2="${centerX+20}" y2="${y_na}" stroke="#3b82f6" stroke-width="1" />`;
            svg += `<line x1="${strainTopX}" y1="${topY}" x2="${strainBottomX}" y2="${y_d + 10}" stroke="#fca5a5" stroke-width="1.5" stroke-dasharray="3 3" />`;
            svg += `<path d="M ${centerX} ${y_na} L ${centerX - w_sc} ${topY} L ${centerX} ${topY} Z" fill="rgba(59,130,246,0.2)" stroke="#3b82f6" />`;
            svg += `<line x1="${centerX}" y1="${y_d}" x2="${centerX + w_ss}" y2="${y_d}" stroke="#ef4444" stroke-width="2" marker-end="url(#arr)" />`;
            
            svg += `<text x="${centerX - w_sc - 4}" y="${topY + 8}" text-anchor="end" font-size="10" fill="#3b82f6" font-weight="bold">${fmt(res.sigma_c)}</text>`;
            svg += `<text x="${centerX + w_ss + 4}" y="${y_d + 4}" font-size="10" fill="#ef4444" font-weight="bold">${fmt(res.sigma_s)}</text>`;
            svg += `</svg>`;
            el.innerHTML = svg;
        }

        // --- Common Functions ---
        function copySection1(targetIdx) {
            if (!confirm('断面1のデータをコピーしますか？')) return;
            const src = sections[0];
            const target = sections[targetIdx];
            ['b','D','dt','dp','barSizeT','barCountT','barSizeC','barCountC','manualAs','manualAsp','Fc','n','rebarType','allowFactor'].forEach(k => target[k] = src[k]);
            renderAll();
        }
        function updateData(idx, key, value) {
            let val = parseFloat(value);
            if (['name', 'barSizeT', 'barSizeC', 'rebarType'].includes(key)) val = value;
            if (typeof val === 'number' && isNaN(val)) val = 0;
            sections[idx][key] = val;
            renderAll();
        }
        function saveData() {
            const blob = new Blob([JSON.stringify(sections, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rc_sections_v2.4.json`;
            a.click();
        }
        function loadData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(Array.isArray(loaded) && loaded.length === 4) {
                        sections = loaded;
                        renderAll();
                        alert("読込完了");
                    }
                } catch(err) { alert("形式エラー"); }
            };
            reader.readAsText(file);
        }
        function toggleModal(show) {
            const el = document.getElementById('logic_modal');
            if (show) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); } 
            else { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); }
        }
        function showLogicInfo() { toggleModal(true); }
        
        function renderAll() {
            const container = document.getElementById('sections_container');
            container.innerHTML = '';
            sections.forEach((sec, idx) => {
                const res = calculateRC(sec);
                const html = createSectionHTML(idx, sec, res);
                container.insertAdjacentHTML('beforeend', html);
                setTimeout(() => {
                    drawSectionDetail(`svg_section_${idx}`, sec, res);
                    drawStressDiagram(`svg_stress_${idx}`, sec, res);
                }, 0);
            });
            lucide.createIcons();
        }

        window.onload = function() {
            renderAll();
        };

        // UI生成関数 (createSectionHTML)
        function createSectionHTML(idx, s, res) {
            const isErr = res.state === 'error';
            
            const makeOpts = (sel) => Object.keys(REBAR_AREAS).map(k => `<option value="${k}" ${k===sel?'selected':''}>${k}</option>`).join('');
            const makeFcOpts = (sel) => Object.keys(CONCRETE_DATA).map(k => `<option value="${k}" ${parseInt(k)===parseInt(sel)?'selected':''}>Fc${k}</option>`).join('');
            const makeRebarOpts = (sel) => Object.keys(REBAR_DATA).map(k => `<option value="${k}" ${k===sel?'selected':''}>${REBAR_DATA[k].name}</option>`).join('');
            const fmt = (v, d=2) => (isErr || isNaN(v)) ? '-' : Math.abs(v).toFixed(d);

            const getStatus = (state) => {
                if (state === 'ng') return '<span class="text-red-600 font-bold bg-red-100 px-1 rounded text-[10px]">NG</span>';
                if (state === 'ok') return '<span class="text-blue-600 font-bold bg-blue-100 px-1 rounded text-[10px]">OK</span>';
                return '-';
            };

            let copyBtn = idx > 0 ? `<button onclick="copySection1(${idx})" class="ml-auto px-2 py-1 text-xs bg-white border border-slate-300 rounded text-slate-500 hover:text-blue-600 transition no-print" title="断面1コピー"><i data-lucide="copy" class="w-3 h-3"></i></button>` : '';

            return `
            <div class="section-card bg-white rounded-lg shadow-sm border border-slate-300 flex flex-col overflow-hidden">
                <div class="px-3 py-2 bg-slate-100 border-b border-slate-300 flex justify-between items-center">
                    <div class="flex items-center gap-2 flex-1">
                        <span class="bg-slate-700 text-white text-xs font-bold px-1.5 rounded">${idx+1}</span>
                        <input type="text" value="${s.name}" onchange="updateData(${idx}, 'name', this.value)" 
                            class="font-bold text-slate-800 bg-transparent border-b border-transparent focus:border-blue-500 p-0 w-full text-sm">
                    </div>
                    ${copyBtn}
                </div>

                <div class="p-3 flex flex-col gap-3 text-sm">
                    <div class="h-[120px] bg-white rounded border border-slate-200 relative flex items-center justify-center overflow-hidden">
                        <div id="svg_section_${idx}" class="w-full h-full"></div>
                    </div>

                    <div class="bg-blue-50/50 border border-blue-100 rounded-lg p-2.5 space-y-2.5">
                        <div class="text-[10px] text-blue-400 font-bold tracking-wider uppercase border-b border-blue-100 mb-1">Input Data</div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <div><span class="text-xs text-slate-500 block">コンクリート</span><select onchange="updateData(${idx}, 'Fc', this.value)" class="w-full border-b border-blue-200 bg-transparent text-right font-mono text-xs">${makeFcOpts(s.Fc)}</select></div>
                            <div><span class="text-xs text-slate-500 block">鉄筋</span><select onchange="updateData(${idx}, 'rebarType', this.value)" class="w-full border-b border-blue-200 bg-transparent text-right font-mono text-xs">${makeRebarOpts(s.rebarType)}</select></div>
                            <div><span class="text-xs text-slate-500 block">割増係数</span><input type="number" step="0.1" value="${s.allowFactor}" onchange="updateData(${idx}, 'allowFactor', this.value)" class="w-full border-b border-blue-200 bg-transparent text-right font-mono text-xs"></div>
                        </div>

                        <div class="grid grid-cols-4 gap-2">
                            <div><span class="text-xs text-slate-500 block text-center">b <span class="text-[9px]">(mm)</span></span><input type="number" value="${s.b}" onchange="updateData(${idx}, 'b', this.value)" class="w-full border-b border-blue-200 bg-transparent text-center font-mono text-sm"></div>
                            <div><span class="text-xs text-slate-500 block text-center">D <span class="text-[9px]">(mm)</span></span><input type="number" value="${s.D}" onchange="updateData(${idx}, 'D', this.value)" class="w-full border-b border-blue-200 bg-transparent text-center font-mono text-sm"></div>
                            <div><span class="text-xs text-slate-500 block text-center">dt <span class="text-[9px]">(mm)</span></span><input type="number" value="${s.dt}" onchange="updateData(${idx}, 'dt', this.value)" class="w-full border-b border-blue-200 bg-transparent text-center font-mono text-sm"></div>
                            <div><span class="text-xs text-slate-500 block text-center">dp <span class="text-[9px]">(mm)</span></span><input type="number" value="${s.dp}" onchange="updateData(${idx}, 'dp', this.value)" class="w-full border-b border-blue-200 bg-transparent text-center font-mono text-sm"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex items-center gap-1"><span class="text-xs text-slate-500 w-5">As</span><select onchange="updateData(${idx}, 'barSizeT', this.value)" class="w-full border rounded px-1 py-0.5 bg-white text-xs font-mono">${makeOpts(s.barSizeT)}</select><span class="text-xs">x</span><input type="number" value="${s.barCountT}" onchange="updateData(${idx}, 'barCountT', this.value)" class="w-10 border rounded px-1 py-0.5 text-center text-xs font-mono"></div>
                            <div class="flex items-center gap-1"><span class="text-xs text-slate-500 w-5">As'</span><select onchange="updateData(${idx}, 'barSizeC', this.value)" class="w-full border rounded px-1 py-0.5 bg-white text-xs font-mono">${makeOpts(s.barSizeC)}</select><span class="text-xs">x</span><input type="number" value="${s.barCountC}" onchange="updateData(${idx}, 'barCountC', this.value)" class="w-10 border rounded px-1 py-0.5 text-center text-xs font-mono"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                             <div><span class="text-xs text-slate-500 block text-center">M <span class="text-[9px]">(kN·m/m)</span></span><input type="number" value="${s.M_kNm}" onchange="updateData(${idx}, 'M_kNm', this.value)" class="w-full border rounded px-2 py-1 text-right font-mono text-sm bg-white"></div>
                             <div><span class="text-xs text-slate-500 block text-center">S <span class="text-[9px]">(kN/m)</span></span><input type="number" value="${s.S_kN}" onchange="updateData(${idx}, 'S_kN', this.value)" class="w-full border rounded px-2 py-1 text-right font-mono text-sm bg-white"></div>
                             <div><span class="text-xs text-slate-500 block text-center">N <span class="text-[9px]">(kN/m)</span></span><input type="number" value="${s.N_kN}" onchange="updateData(${idx}, 'N_kN', this.value)" class="w-full border rounded px-2 py-1 font-bold text-blue-700 text-right font-mono text-sm bg-white"></div>
                        </div>
                    </div>

                    <div class="bg-emerald-50/50 border border-emerald-100 rounded-lg p-2.5 space-y-2">
                        <div class="text-[10px] text-emerald-500 font-bold tracking-wider uppercase border-b border-emerald-100 mb-1 flex justify-between">
                            <span>Calculation Result</span>
                            <span class="font-mono normal-case text-slate-500">x = ${fmt(res.x, 1)} mm</span>
                        </div>

                        <div class="h-[80px] w-full relative flex items-center justify-center overflow-visible mb-2">
                            <div id="svg_stress_${idx}" class="w-full h-full"></div>
                        </div>

                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-slate-400 border-b border-emerald-200">
                                    <th class="text-left font-normal pb-1">項目</th>
                                    <th class="text-right font-normal pb-1">発生</th>
                                    <th class="text-right font-normal pb-1">許容</th>
                                    <th class="text-center font-normal pb-1 w-10">判定</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-emerald-100">
                                <tr>
                                    <td class="py-1"><span class="math-expr font-bold">σc</span> 曲げ圧縮 <span class="text-[9px] text-slate-400">(N/mm²)</span></td>
                                    <td class="py-1 text-right font-mono font-bold text-blue-700">${fmt(res.sigma_c)}</td>
                                    <td class="py-1 text-right font-mono text-slate-500">${res.allow_sigC.toFixed(1)}</td>
                                    <td class="py-1 text-center">${getStatus(res.bendStateC)}</td>
                                </tr>
                                <tr>
                                    <td class="py-1"><span class="math-expr font-bold">σs</span> 鉄筋引張 <span class="text-[9px] text-slate-400">(N/mm²)</span></td>
                                    <td class="py-1 text-right font-mono font-bold text-red-600">${fmt(res.sigma_s, 1)}</td>
                                    <td class="py-1 text-right font-mono text-slate-500">${res.allow_sigS.toFixed(0)}</td>
                                    <td class="py-1 text-center">${getStatus(res.bendStateS)}</td>
                                </tr>
                                <tr>
                                    <td class="py-1"><span class="math-expr font-bold">τ</span> せん断 <span class="text-[9px] text-slate-400">(N/mm²)</span></td>
                                    <td class="py-1 text-right font-mono font-bold text-slate-800">${fmt(res.tau, 3)}</td>
                                    <td class="py-1 text-right font-mono text-slate-500">${fmt(res.fa, 3)}</td>
                                    <td class="py-1 text-center">${getStatus(res.shearState)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            `;
        }

    </script>
</body>
</html>
